name: Jest Flaky Tests Analysis

on:
  schedule:
    - cron: "0 1 * * *"  # Runs every day at 1:00 AM UTC
  workflow_dispatch:
    inputs:
      num_runs:
        description: "Number of times to run tests per Node version"
        required: false
        default: "50"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NUM_RUNS: ${{ github.event.inputs.num_runs || 50 }}

jobs:
  setup-matrix-env:
    runs-on: ubuntu-24.04
    outputs:
      NODEJS_BC: ${{ steps.compute-matrix.outputs.NODEJS_BC }}
      NODEJS_DEV: ${{ steps.compute-matrix.outputs.NODEJS_DEV }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: gather versions
        uses: endorama/asdf-parse-tool-versions@v1
      - name: Compute matrix
        id: compute-matrix
        run: |
          echo "NODEJS_BC=20.20.0" >> $GITHUB_OUTPUT
          echo "NODEJS_DEV=${{ env.NODEJS_VERSION }}" >> $GITHUB_OUTPUT

  npm-deps:
    name: Npm dependencies
    needs: [setup-matrix-env]
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - nodejs: ${{ needs.setup-matrix-env.outputs.NODEJS_BC }}
          - nodejs: ${{ needs.setup-matrix-env.outputs.NODEJS_DEV }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Node
        id: setup-node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.nodejs }}
      - name: Retrieve NPM Cached Dependencies
        uses: actions/cache@v5
        id: npm-cache
        with:
          path: |
            assets/node_modules
          key: nodejs-${{ steps.setup-node.outputs.node-version }}-${{ hashFiles('assets/package-lock.json') }}
      - name: Install NPM dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: cd assets && npm ci

  generate-matrix:
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
      total-runs: ${{ steps.generate.outputs.total-runs }}
    steps:
      - name: Generate Matrix
        id: generate
        run: |
          echo "{\"run\": [$(seq -s, 1 ${{ env.NUM_RUNS }})]}" > matrix.json
          echo "matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT
          echo "total-runs=$(( ${{ env.NUM_RUNS }} * 2 ))" >> $GITHUB_OUTPUT
        shell: bash

  test-javascript:
    name: Javascript tests (Node ${{ matrix.nodejs }}, Run ${{ matrix.run }})
    needs: [setup-matrix-env, npm-deps, generate-matrix]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        run: ${{ fromJson(needs.generate-matrix.outputs.matrix).run }}
        nodejs:
          - ${{ needs.setup-matrix-env.outputs.NODEJS_BC }}
          - ${{ needs.setup-matrix-env.outputs.NODEJS_DEV }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Node
        id: setup-node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.nodejs }}
      - name: Retrieve NPM Cached Dependencies
        uses: actions/cache@v5
        id: npm-cache
        with:
          path: |
            assets/node_modules
          key: nodejs-${{ steps.setup-node.outputs.node-version }}-${{ hashFiles('assets/package-lock.json') }}
      - name: Set ENV_TS to get current Timestamp for JUnit reports
        run: echo "ENV_TS=$(date +%F_%T | sed 's/:/-/g')" >> $GITHUB_ENV
      - name: Run JS tests
        run: cd assets && npm test
        env:
          JEST_JUNIT_OUTPUT_DIR: /tmp
          JEST_JUNIT_OUTPUT_NAME: jest-junit-node${{ matrix.nodejs }}-run${{ matrix.run }}-${{ env.ENV_TS }}.xml
      - name: Upload jest test junit reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: jest-junit-reports-node${{ matrix.nodejs }}-run${{ matrix.run }}
          path: /tmp/*.xml

  flaky-tests-analysis:
    needs: [test-javascript, setup-matrix-env, generate-matrix]
    if: ${{ !cancelled() }}
    uses: ./.github/workflows/flaky-tests-analysis.yaml
    with:
      suite-name: Jest
      junit-artifact-pattern: jest-junit-reports-*
      total-runs: ${{ needs.generate-matrix.outputs.total-runs }}
