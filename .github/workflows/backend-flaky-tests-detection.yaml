
name: Backend Flaky Tests Analysis

on:
  push:
  schedule:
    - cron: '0 3 * * 1' # Runs every monday at 3:00 AM UTC
  workflow_dispatch:

env:
  MIX_ENV: test
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.12.3"
  DEFAULT_NUM_CONTAINERS: 100

jobs:
  elixir-deps:
    name: Elixir ${{ matrix.mix_env }} dependencies
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - mix_env: dev
          - mix_env: test
    env:
      MIX_ENV: ${{ matrix.mix_env }}
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup
        id: setup-elixir
        uses: erlef/setup-beam@v1
        with:
          version-file: .tool-versions
          version-type: strict
      - name: Retrieve Cached Dependencies
        uses: actions/cache@v4
        id: mix-cache
        with:
          path: |
            deps
            _build/${{ matrix.mix_env }}
            priv/plts
          key: ${{ runner.os }}-${{ steps.setup-elixir.outputs.otp-version }}-${{ steps.setup-elixir.outputs.elixir-version }}-${{ hashFiles('mix.lock') }}
      - name: Install Dependencies
        if: steps.mix-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p priv/plts
          mix local.rebar --force
          mix local.hex --force
          MIX_ENV=test mix deps.get
          mix deps.compile --warnings-as-errors
          mix dialyzer --plt

  npm-deps:
    name: Npm dependencies
    runs-on: ubuntu-24.04
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Retrieve Cached Dependencies
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: |
            assets/node_modules
          key: ${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('assets/package-lock.json') }}
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install NPM dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: cd assets && npm install

  test-backend:
    name: Backend Tests Run
    needs: [elixir-deps]
    runs-on: ubuntu-24.04
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup
        id: setup-elixir
        uses: erlef/setup-beam@v1
        with:
          version-file: .tool-versions
          version-type: strict
      - name: Retrieve Cached Dependencies
        uses: actions/cache@v4
        id: mix-cache
        with:
          path: |
            deps
            _build/dev
            priv/plts
          key: ${{ runner.os }}-${{ steps.setup-elixir.outputs.otp-version }}-${{ steps.setup-elixir.outputs.elixir-version }}-${{ hashFiles('mix.lock') }}
      - name: Compile
        run: mix compile --warnings-as-errors
      - name: "Docker compose dependencies"
        uses: isbang/compose-action@v2.1.0
        with:
          compose-file: "./docker-compose.yaml"
          down-flags: "--volumes"
      - name: Run backend tests
        working-directory: hack/flaky_tests_analysis
        run: make gen-test-data-be N-TIMES=1
      - name: Copy and sanitize .xml files from /tmp to ./junit-reports
        run: |
          mkdir -p ./junit-reports
          for file in /tmp/*.xml; do
            if [ -f "$file" ]; then
              # Sanitize filename: replace colons ':' with hyphens '-'
              sanitized_name=$(basename "$file" | tr ':' '-')
              # Sanitize contents: replace colons with hyphens
              awk '{gsub(/:/, "-"); print}' "$file" > "./junit-reports/$sanitized_name"
            fi
          done
      - name: Upload backend tests junit reports
        uses: actions/upload-artifact@v4
        with:
          name: junit-reports
          path: junit-reports/*.xml

  flaky-tests-analysis:
    name: Flaky Tests Analysis
    needs: test-backend
    runs-on: ubuntu-24.04
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    
      - name: Download JUnit reports artifacts
        uses: actions/download-artifact@v4
        with:
          # path: junit-reports
          # pattern: backend-junit-reports
      - name: Analyze
        run: |
          make venv-create
          source .venv/bin/activate
          make install-deps
          make PATH-TO-JUNIT-FILES=../../junit-reports analyze-files 2>&1 | tail -n +2 >> $GITHUB_STEP_SUMMARY
      #   working-directory: hack/flaky_tests_analysis
      # - name: Delete Artifacts
      #   uses: geekyeggo/delete-artifact@v5
      #   with:
      #     name: backend-junit-reports
