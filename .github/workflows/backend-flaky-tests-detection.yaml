name: Backend Flaky Tests Analysis

on:
  schedule:
    - cron: "0 0 * * 1" # Runs every monday at 00:00 AM UTC
  workflow_dispatch:
    inputs:
      num_runs:
        description: "Number of times to run tests"
        required: false
        default: "10"

concurrency:
  group: ${{ github.workflow }}

env:
  MIX_ENV: test
  NUM_RUNS: ${{ github.event.inputs.num_runs || 10 }}

jobs:
  elixir-deps:
    name: Elixir test dependencies
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup
        id: setup-elixir
        uses: erlef/setup-beam@v1
        with:
          version-file: .tool-versions
          version-type: strict
      - name: Retrieve Elixir Cached Dependencies
        uses: actions/cache@v5
        id: mix-cache
        with:
          path: |
            deps
            _build/${{ env.MIX_ENV }}
            priv/plts
          key: erlang-${{ steps.setup-elixir.outputs.otp-version }}-elixir-${{ steps.setup-elixir.outputs.elixir-version }}-${{ hashFiles('mix.lock') }}-${{ env.MIX_ENV }}
      - name: Install Dependencies
        if: steps.mix-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p priv/plts
          mix local.rebar --force
          mix local.hex --force
          mix deps.get
          mix deps.compile --warnings-as-errors
          mix dialyzer --plt

  generate-matrix:
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
      total-runs: ${{ steps.generate.outputs.total-runs }}
    steps:
      - name: Generate Matrix
        id: generate
        run: |
          echo "{\"run\": [$(seq -s, 1 ${{ env.NUM_RUNS }})]}" > matrix.json
          echo "matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT
          echo "total-runs=${{ env.NUM_RUNS }}" >> $GITHUB_OUTPUT
        shell: bash

  test-backend:
    name: Backend Tests (Run ${{ matrix.run }})
    needs: [elixir-deps, generate-matrix]
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        run: ${{ fromJson(needs.generate-matrix.outputs.matrix).run }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup
        id: setup-elixir
        uses: erlef/setup-beam@v1
        with:
          version-file: .tool-versions
          version-type: strict
      - name: Retrieve Elixir Cached Dependencies
        uses: actions/cache@v5
        id: mix-cache
        with:
          path: |
            deps
            _build/${{ env.MIX_ENV }}
            priv/plts
          key: erlang-${{ steps.setup-elixir.outputs.otp-version }}-elixir-${{ steps.setup-elixir.outputs.elixir-version }}-${{ hashFiles('mix.lock') }}-${{ env.MIX_ENV }}
      - name: Compile
        run: mix compile --warnings-as-errors
      - name: "Docker compose dependencies"
        uses: isbang/compose-action@v2.5.0
        with:
          compose-file: "./docker-compose.yaml"
          down-flags: "--volumes"
      - name: Run backend tests
        env:
          WRITE_JUNIT: 1
        run: mix test
      - name: Copy and sanitize JUnit reports
        if: always()
        run: |
          mkdir -p ./junit-reports
          for file in /tmp/*.xml; do
            if [ -f "$file" ]; then
              base=$(basename "$file" | tr ':' '-' | tr ' ' '_')
              awk '{gsub(/:/, "-"); print}' "$file" > "./junit-reports/$base"
            fi
          done
      - name: Upload backend test junit reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: backend-junit-reports-run${{ matrix.run }}
          path: junit-reports/*.xml

  flaky-tests-analysis:
    needs: [test-backend, generate-matrix]
    if: ${{ !cancelled() }}
    uses: ./.github/workflows/flaky-tests-analysis.yaml
    with:
      suite-name: Backend
      junit-artifact-pattern: backend-junit-reports-*
      total-runs: ${{ needs.generate-matrix.outputs.total-runs }}
